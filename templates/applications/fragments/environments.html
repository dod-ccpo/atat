{% from "components/alert.html" import Alert %}
{% from "components/icon.html" import Icon %}
{% from "components/label.html" import Label %}
{% from 'components/save_button.html' import SaveButton %}
{% from "components/text_input.html" import TextInput %}
{% from "components/toggle_list.html" import ToggleButton, ToggleSection %}

{% macro EnvironmentManagementTemplate(
  application,
  environments_obj,
  new_env_form) %}

  <h3>{{ "portfolios.applications.settings.environments" | translate }}</h3>
  {% if portfolio.num_task_orders == 0 -%}
    {{ Alert(message="portfolios.applications.environments.funding_alert"|translate({'name': portfolio.name})) }}
  {%- endif %}
  {% if g.matchesPath("application-environments") -%}
    {% include "fragments/flash.html" %}
  {%- endif %}
  <section class="panel" id="application-environments">
    {% if 0 == environments_obj | length -%}
      <div class="empty-state panel__content">
        <p class="empty-state__message">
          {{ 'portfolios.applications.environments.blank_slate' | translate }}
        </p>
      </div>
    {% else %}
      <div class="panel__content">
        <div class="accordion-table accordion-table-list">
          <ul class="accordion-table__items">
            {% for env in environments_obj %}
              {% set edit_form = env['edit_form'] %}
              <toggler inline-template>
                <li class="accordion-table__item">
                  <div class="accordion-table__item-content">
                    <div class="environment-list__item">
                      <div class="environment-list__item-line">
                        {% if not env["pending"] -%}
                          <span>
                            <a
                              href='https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?client_id=c44b4083-3bb0-49c1-b47d-974e53cbdf3c&response_type=code%20id_token&scope=https%3A%2F%2Fmanagement.core.windows.net%2F%2Fuser_impersonation%20openid%20email%20profile&state=OpenIdConnect.AuthenticationProperties%3DAycnjO5P4Zk79JNdawIr60DDDPLL6cTotjqNC3QjO6fFyAGNenXuZz-aAag18Z4t0ANYTTyQLK0b68sk9Vy5N6ZcrkRokhinrCqV-ZHIfHc8wc2iaEzdTVAZnyYPxK6OsOwS1QXKnZRuxAhhpcNGKPU3ofW6CczC6jsNw4EI-Ealgru9WAx8URo-BC5Bm7XoIx2o8ArSkSonn-CL1hToul8VzM8t99O8tf4f6OqkmQforHjdnaPPVgNGgL1nwnt4Nq-z2mpViGPqu9bSmqc3VvvLzbrgS72RnAJDZaV4XKQ9tDe5EuxvQIPiDoKHP0DB&response_mode=form_post&nonce=637547482255287202.YWQ3NzM0NjUtODQwYy00OWQzLWJmMTUtOGE3YzlmMTRlMmYwZjljZjE5ZWEtNTcxMS00ZTUyLTg3NjEtYzU0ZGE1YTQ3ZjE5&redirect_uri=https%3A%2F%2Fportal.azure.com%2Fsignin%2Findex%2F&site_id=501430&client-request-id=20eaa568-fe03-479b-af4d-226c4bb5d4e4&x-client-SKU=ID_NET45&x-client-ver=5.3.0.0'
                              target='_blank'
                              rel='noopener noreferrer'>
                              {{ env['name'] }} {{ Icon('link', classes='icon--medium icon--primary') }}
                              {{applications}}
                            </a>
                          </span>
                        {% else -%}
                          <span>
                            {{ env['name'] }}
                          </span>
                          {{ Label(type="pending_creation")}}
                        {%- endif %}
                        {% if user_can(permissions.EDIT_ENVIRONMENT) -%}
                          {{
                          ToggleButton(
                            open_html="common.edit"|translate,
                            close_html="common.close"|translate,
                            section_name="edit"
                            )
                          }}
                        {%- endif %}
                      </div>
                      <div class="environment-list__item-line">
                        {% set members_button = "portfolios.applications.member_count" | translate({'count': env['member_count']}) %}
                        {{
                          ToggleButton(
                            open_html=members_button,
                            close_html=members_button,
                            section_name="members",
                            classes="environment-list__item__members"
                          )
                        }}
                      </div>
                    </div>
                  </div>

                  {% call ToggleSection(section_name="members") %}
                    <ul>
                      {% for member in env['members'] %}
                      {% set status = "portfolios.applications.environments.disabled"|translate if member['status'] == 'disabled' %}
                      <li class="accordion-table__item-toggle-content__expanded">
                        {{ member['user_name'] }}{{ status }}
                      </li>
                      {% endfor %}
                    </ul>
                  {% endcall %}

                  {% if user_can(permissions.EDIT_ENVIRONMENT) -%}
                    {% call ToggleSection(section_name="edit") %}
                      <ul>
                        <li class="accordion-table__item-toggle-content__expanded environment-list__edit">
                          <base-form inline-template>
                            <form
                              action="{{ url_for('applications.update_environment', environment_id=env['id']) }}"
                              method="post"
                              v-on:submit="handleSubmit"
                              class="col col--half">
                              {{ edit_form.csrf_token }}
                              {{ TextInput(edit_form.name, validation='defaultStringField', optional=False) }}
                              <div class="action-group action-group--tight">
                                {{
                                  SaveButton(
                                    text=("common.save_changes" | translate)
                                  )
                                }}
                              </div>
                              <button
                                type="submit"
                                formaction="{{ url_for('applications.create_subscription', environment_id=env.id)}}"
                                class="usa-button usa-button-secondary">
                                {{ "portfolios.applications.environments.add_subscription" | translate }}
                              </button>
                            </form>
                          </base-form>
                        </li>
                      </ul>
                    {% endcall %}
                  {%- endif %}
                </li>
              </toggler>
            {% endfor %}
          </ul>
        </div>
      </div>
    {%- endif %}
    {% if user_can(permissions.CREATE_ENVIRONMENT) -%}
      {% include "applications/fragments/add_new_environment.html" %}
    {%- endif %}
  </section>
{% endmacro %}
