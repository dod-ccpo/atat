- name: set tf_dir
  set_fact:
    tf_dir: "{{ tf_base_dir }}/{{ tf_subdir }}"

- name: plan (no modules)
  terraform:
    force_init: "{{ bootstrap_init_tf }}"
    project_path: "{{ tf_dir }}"
    state: "planned"
    plan_file: "plan.tfplan"
    variables: "{{ kv_tf  }}"
  register: tf_bootstrap_run
  environment:
    ARM_SUBSCRIPTION_ID: "{{ bootstrap_subscription_id }}"
    TF_VAR_environment: "{{ az_environment }}"
  when:
    - target_modules is not defined
    - az_environment is defined

- name: plan  (modules)
  terraform:
    force_init: "{{ bootstrap_init_tf }}"
    project_path: "{{ tf_dir }}"
    state: "planned"
    plan_file: "plan.tfplan"
    targets: "{{ target_modules }}"
    variables: "{{ kv_tf }}"
  register: tf_bootstrap_run
  environment:
    ARM_SUBSCRIPTION_ID: "{{ bootstrap_subscription_id }}"
  when:
    - target_modules is defined
    - az_environment is not defined

- name: tf apply (no modules)
  terraform:
    force_init: "{{ bootstrap_init_tf }}"
    project_path: "{{ tf_dir }}"
    state: "present"
    variables: "{{ kv_tf }}"
  register: tf_bootstrap_backend_outputs
  environment:
    ARM_SUBSCRIPTION_ID: "{{ bootstrap_subscription_id }}"
    TF_VAR_environment: "{{ az_environment }}"
  when:
    - target_modules is not defined
    - az_environment is defined

- name: tf apply (no modules)
  terraform:
    force_init: "{{ bootstrap_init_tf }}"
    project_path: "{{ tf_dir }}"
    state: "present"
    variables: "{{ kv_tf }}"
  register: tf_bootstrap_backend_outputs
  environment:
    ARM_SUBSCRIPTION_ID: "{{ bootstrap_subscription_id }}"
  when:
    - target_modules is not defined
    - az_environment is not defined

- debug:
    msg: "{{ tf_bootstrap_backend_outputs.outputs }}"
  when: tf_bootstrap_backend_outputs.outputs is defined
