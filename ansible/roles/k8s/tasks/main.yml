---
- name: Apply kubernetes configurations
  hosts: localhost
  tasks:
<<<<<<< HEAD
    - name: Show variable "az_environment"
      debug:
        msg: "{{ az_environment }}"

    # - name: run add aks perms
    #   shell:
    #     cmd: script/add-aks-perms.sh dryrun2
    #     chdir: /Users/jesus/Workspace/atst

    - name: Connect to the kubernetes cluster
      shell: "az aks get-credentials -g cloudzero-{{ az_environment }}-vpc -n cloudzero-{{ az_environment }}-k8s" # TODO(heyzoos) Variablize! From terraform outputs.

    - shell: kubectl get nodes
      register: nodes

    - debug:
        msg: "{{ nodes }}"

    - name: Verify login to the kubernetes cluster
      assert:
        that:
          - nodes # TODO(heyzoos) What should I put here?
=======
    - name: Connect to the {{ namespace }} kubernetes cluster
      shell: "az aks get-credentials -g cloudzero-{{ namespace }}-vpc -n cloudzero-{{ namespace }}-k8s"
>>>>>>> Interpolate all the namespace variables

    - name: Create HTTP Basic Auth Password
      set_fact:
        password: "{{ lookup('password', 'htpasswd') }}"

    - name: Dump htpassword into file
      copy:
        dest: "./htpasswd"
        content: "{{ password }}"

    - name: Base64 encode the password
      shell: 'echo "{{ password }}" | base64'
      register: encoded_password_shell_output

<<<<<<< HEAD
    - debug:
        msg: "{{ encoded_password_shell_output }}"

    - name: Create {{ az_environment }} namespace
=======
    - name: Create {{ namespace }} namespace
>>>>>>> Interpolate all the namespace variables
      k8s:
        kind: Namespace
        state: present
        name: "{{ namespace }}"

    - name: Set password
      k8s:
        name: htpasswd
        kind: Secret
        state: present
        namespace: "{{ namespace }}"
        definition:
          type: Opaque
          data:
            secret: "{{ encoded_password_shell_output.stdout }}"

    - name: Apply the storage class
      k8s:
        state: present
        src: ../../../../deploy/azure/storage-class.yml

    - name: Create kv namespace
      k8s:
        kind: Namespace
        state: present
        name: "kv"

    - name: Apply flex vol installer
      k8s:
        state: present
        src: ../../../../deploy/azure/keyvault/kv-flex-vol-installer.yml

    - name: Create template output directory
      file:
        state: directory
        path: .out.{{ namespace }}

    - name: Interpolate the templates
      template:
        src: "{{ item }}"
        dest: ".out.{{ namespace }}/{{ item | basename }}"
      with_fileglob: "{{ playbook_dir + '/templates/*' }}"

<<<<<<< HEAD
    #- name: Perform a diff to ensure the config can load correctly
    #  shell: ../../../../script/k8s_config ../../../../deploy/overlays/cloudzero-pwdev-dryrun2 | kubectl diff -f -
    vars_prompt:
        - name: atat_container_image_version
          prompt: "State the atat container image version in {{ tf_app_env_outputs.container_registry_name.value }}.azurecr.io/atat you'd like to deploy"
          private: no
        - name: nginx_container_image_version
          prompt: "State the nginx container image version in {{ tf_app_env_outputs.container_registry_name.value }}.azurecr.io/atat you'd like to deploy"
          private: no

=======
    - name: Show output directory
      debug:
        msg: "{{ playbook_dir + '/.out.' + namespace }}"
>>>>>>> Interpolate all the namespace variables

    - name: Apply the rest of the Kubernetes config for the site
      shell: ../../../../script/k8s_config {{ playbook_dir + '/.out.' + namespace }} | kubectl apply -f -
      environment:
<<<<<<< HEAD
        CONTAINER_IMAGE: "{{ tf_app_env_outputs.container_registry_name.value }}.azurecr.io/atat:{{atat_container_image_version}}"
        NGINX_CONTAINER_IMAGE: "{{ tf_app_env_outputs.container_registry_name.value }}.azurecr.io/nginx:{{nginx_container_image_version}}"
        MAIN_DOMAIN: "{{az_environment}}".atat.dev
        AUTH_DOMAIN: auth-"{{az_environment}}".atat.dev
        # TODO(heyzoos) Where did we source this ID from??
        # VMSS_CLIENT_ID: 6c3cab5d-f037-4a00-9271-1756656bee92
        VMSS_CLIENT_ID: 1213334e-f149-4f5a-a5e0-550eef158a75
        KV_NAME: "cz--keyvault"
        TENANT_ID: "{{tf_app_env_outputs.tenant_id.value}}"
=======
        #TODO(heyzoos) all these need to come from ansible outputs
        CONTAINER_IMAGE: cloudzero{{ namespace }}registry.azurecr.io/atat:staging-a6a789ac8bf583b0764e2853dbde95173bc1e5b7
        NGINX_CONTAINER_IMAGE: cloudzero{{ namespace }}registry.azurecr.io/nginx:rhel-8.2
        MAIN_DOMAIN: "{{ namespace }}.atat.dev"
        AUTH_DOMAIN: "auth-{{ namespace }}.atat.dev"
        # TODO(heyzoos) Where did we source this ID from??
        # VMSS_CLIENT_ID: 6c3cab5d-f037-4a00-9271-1756656bee92
        VMSS_CLIENT_ID: 1213334e-f149-4f5a-a5e0-550eef158a75
        KV_NAME: "cz-{{ namespace }}-keyvault"
        TENANT_ID: b5ab0e1e-09f8-4258-afb7-fb17654bc5b3
>>>>>>> Interpolate all the namespace variables

    - name: Obtain IP addresses
      shell: kubectl -n {{ namespace }} get services
      register: ips

    - name: Show IP addresses
      debug:
        msg: "{{ ips }}"
